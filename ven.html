<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üí≥ Venta - Farmacia Ortopedia Lili</title>
<style>
*{box-sizing:border-box;}
body{font-family:system-ui,sans-serif;background:#1e2f52;color:#e5e7eb;margin:0;padding:0;height:100vh;display:flex;flex-direction:column;}
header{background:hsl(221, 39%, 11%);padding:16px;font-size:20px;font-weight:bold;text-align:center;}
main{flex:1;padding:0;display:flex;flex-direction:column;}
.card{
  background:linear-gradient(120deg,#111827 80%,#2563eb11 100%);
  border-radius:0;
  flex:1;
  display:flex;
  flex-direction:column;
  padding:16px;
}
input,button,select{padding:9px;border-radius:6px;border:none;margin:4px 0;}
input,select{width:100%;}
input[readonly]{background:#374151;color:#ccc;}
button{background:#2563eb;color:white;cursor:pointer;font-weight:bold;}
button:hover{background:#1d4ed8;}
.tabla-contenedor{
  flex:1;
  overflow-y:auto;
  margin-top:10px;
  border:1px solid #374151;
  border-radius:8px;
  background:#0f172a;
}
table{width:100%;border-collapse:collapse;}
th,td{padding:8px;border-bottom:1px solid #374151;text-align:left;}
#clienteForm{display:none;margin-top:12px;background:#1f2937;padding:12px;border-radius:8px;display:flex;flex-wrap:wrap;gap:4px;}
#clienteForm input{flex:1;}
#pagoForm{margin-top:8px;display:flex;flex-wrap:wrap;gap:8px;}
#pagoForm input,#pagoForm select{flex:1;}
#btnCobrar{margin-top:8px;background:#16a34a;}
#btnNuevaVenta{margin-top:4px;background:#f59e0b;}
.main-menu{display:flex;gap:12px;background:#111827;padding:10px 16px;position:sticky;top:0;z-index:1000;border-bottom:1px solid #1f2937;}
.main-menu .menu-link{color:#e5e7eb;text-decoration:none;padding:8px 12px;border-radius:8px;font-weight:500;transition:0.2s;}
.main-menu .menu-link:hover{background:#1f2937;}
.main-menu .menu-link.active{background:#2563eb;color:white;}
#logout{background:#dc2626;margin-left:auto;}
#cajero{font-size:14px;margin-left:16px;color:#facc15;}
</style>
</head>
<body>
<header>üí≥ Venta - Farmacia Ortopedia Lili</header>
<nav class="main-menu">
  <a href="ven.html" class="menu-link active">üí≥ Ventas</a>
  <a href="inven.html" class="menu-link">üì¶ Inventario</a>
  <a href="hitori.html" class="menu-link">üìú Historial</a>
  <span id="cajero"></span>
  <button id="logout">Cerrar Sesi√≥n</button>
</nav>
<main>
  <div id="ventaCard" class="card" style="display:none;">
    <h3>Vender producto</h3>
    <input type="text" id="searchProducto" placeholder="Escanea o escribe c√≥digo/nombre">
    
    <div class="tabla-contenedor">
      <table id="tablaVenta">
        <thead>
          <tr>
            <th>Producto</th>
            <th>C√≥digo</th>
            <th>Cant.</th>
            <th>Precio</th>
            <th>Subtotal</th>
            <th>Caducidad</th>
            <th>Lote</th>
            <th>Status</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    
    <p id="totalVenta" style="font-weight:bold;margin-top:8px;">Total: $0.00</p>
    
    <div id="clienteForm">
      <input type="text" id="clienteNombre" placeholder="Nombre del Doctor">
      <input type="text" id="clienteCedula" placeholder="C√©dula profesional" maxlength="8">
      <input type="text" id="clienteDireccion" placeholder="Direcci√≥n">
      <input type="text" id="folioReceta" placeholder="Folio de receta" maxlength="8">
    </div>
    
    <div id="pagoForm">
      <input type="number" id="pagoInput" placeholder="Pago recibido" min="0">
      <input type="text" id="cambioDisplay" placeholder="Cambio" readonly>
      <select id="metodoPago">
        <option value="Efectivo">Efectivo</option>
        <option value="Tarjeta">Tarjeta</option>
        <option value="Proveedores">Proveedores</option>
        <option value="Transferencia">Transferencia</option>
      </select>
    </div>
    
    <button id="btnCobrar">Cobrar</button>
 
  </div>
</main>

<script>
let usuarioActivo = localStorage.getItem("usuarioActivo");
if(!usuarioActivo){ window.location.href="index.html"; }
else { 
  document.getElementById("cajero").textContent = "üë§ Cajero: "+usuarioActivo; 
  document.getElementById("ventaCard").style.display="flex"; 
}

// Inventario de ejemplo
let inventario = JSON.parse(localStorage.getItem('inventario')) || [
  {nombre:"Ibuprofeno",codigo:"A001",precio:50,lote:"L001",stock:10,caducidad:"2025-12-31"},
  {nombre:"Paracetamol",codigo:"B002",precio:30,lote:"L002",stock:20,caducidad:"2026-06-30"},
  {nombre:"Amoxicilina",codigo:"A003",precio:80,lote:"L003",stock:15,caducidad:"2025-11-15"},
];
localStorage.setItem('inventario', JSON.stringify(inventario));

// Venta persistente
let venta = JSON.parse(localStorage.getItem('ventaActiva')) || [];
let folioCounter = parseInt(localStorage.getItem('folioCounter')||1);

function guardarInventario(){ localStorage.setItem('inventario', JSON.stringify(inventario)); }
function guardarVentas(ventaData){ 
  const historial = JSON.parse(localStorage.getItem('ventas'))||[];
  historial.push(ventaData);
  localStorage.setItem('ventas', JSON.stringify(historial));
}
function guardarVentaActiva(){ localStorage.setItem('ventaActiva', JSON.stringify(venta)); }

function renderVenta(){
  const tbody = document.querySelector('#tablaVenta tbody');
  tbody.innerHTML='';
  let total=0;
  let mostrarClienteForm = false;

  venta.forEach((v,i)=>{
    let subtotal = v.precio*v.cantidad;
    total+=subtotal;
    const diff = (new Date(v.caducidad) - new Date())/(1000*60*60*24);
    let estatus = diff<0 ? "Caducado" : diff<=30 ? "Pr√≥ximo" : "OK";
    const esAntibiotico = v.codigo.toUpperCase().startsWith("A");
    if(esAntibiotico) mostrarClienteForm = true;

    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input type="text" value="${v.nombre}" readonly></td>
      <td><input type="text" value="${v.codigo}" readonly></td>
      <td><input type="number" value="${v.cantidad}" min="1" onchange="actualizarCantidad(${i},this.value)"></td>
      <td><input type="text" value="${v.precio}" readonly></td>
      <td><input type="text" value="${subtotal.toFixed(2)}" readonly></td>
      <td><input type="text" value="${esAntibiotico ? v.caducidad : ''}" readonly></td>
      <td><input type="text" value="${esAntibiotico ? v.lote : ''}" readonly></td>
      <td><input type="text" value="${estatus}" readonly></td>
      <td><button onclick="eliminarVenta(${i})">üóëÔ∏è</button></td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById('totalVenta').textContent = "Total: $"+total.toFixed(2);
  document.getElementById('clienteForm').style.display = mostrarClienteForm ? 'flex' : 'none';
  guardarVentaActiva();
}

function actualizarCantidad(index, value){
  value = parseInt(value)||1;
  venta[index].cantidad = value;
  renderVenta();
  actualizarCambio();
}

// Esc√°ner (simula entrada de teclado)
document.getElementById('searchProducto').addEventListener('keydown', e=>{
  if(e.key==='Enter'){ e.preventDefault(); agregarProducto(e.target.value); }
});

function agregarProducto(busqueda){
  if(!busqueda) return;
  const prod = inventario.find(p=>p.codigo.toLowerCase()===busqueda.toLowerCase()||p.nombre.toLowerCase()===busqueda.toLowerCase());
  if(!prod) return alert("Producto no encontrado");
  if(prod.stock<=0) return alert("Producto sin stock");
  const yaExiste = venta.find(v=>v.codigo===prod.codigo);
  if(yaExiste){
    if(yaExiste.cantidad+1 > prod.stock) return alert("No hay suficiente stock");
    yaExiste.cantidad++;
  } else {
    venta.push({...prod, cantidad:1});
  }
  document.getElementById('searchProducto').value='';
  renderVenta();
  actualizarCambio();
}

function eliminarVenta(i){ venta.splice(i,1); renderVenta(); actualizarCambio(); }

document.getElementById("logout").onclick=()=>{ 
  localStorage.removeItem("usuarioActivo"); 
  window.location.href="index.html"; 
};

function actualizarCambio(){
  const total = venta.reduce((acc,v)=>acc+v.precio*v.cantidad,0);
  const pago = parseFloat(document.getElementById('pagoInput').value)||0;
  document.getElementById('cambioDisplay').value = pago>=total ? (pago-total).toFixed(2) : "0.00";
}

document.getElementById('pagoInput').addEventListener('input', actualizarCambio);

// Cobrar
document.getElementById("btnCobrar").onclick = () => {
  if(venta.length === 0) return alert("No hay productos en la venta");

  const contieneAntibiotico = venta.some(v=>v.codigo.toUpperCase().startsWith("A"));
  if(contieneAntibiotico){
    const nombre=document.getElementById("clienteNombre").value.trim();
    const cedula=document.getElementById("clienteCedula").value.trim();
    const direccion=document.getElementById("clienteDireccion").value.trim();
    const folio=document.getElementById("folioReceta").value.trim();
    if(!nombre||!cedula||!direccion||!folio) return alert("Complete todos los campos del doctor");
  }

  const metodoPago=document.getElementById("metodoPago").value;
  const fecha=new Date().toLocaleString();
  const total = venta.reduce((acc,v)=>acc+v.precio*v.cantidad,0);
  const ventaData = {folio:folioCounter++, fecha, cajero:usuarioActivo, metodo:metodoPago, total, items:venta.map(v=>({nombre:v.nombre,codigo:v.codigo,cantidad:v.cantidad,precio:v.precio,lote:v.lote}))};
  if(contieneAntibiotico){
    ventaData.doctor = {
      nombre: document.getElementById("clienteNombre").value,
      cedula: document.getElementById("clienteCedula").value,
      direccion: document.getElementById("clienteDireccion").value,
      folioReceta: document.getElementById("folioReceta").value
    };
  }

  venta.forEach(v=>{ const prod=inventario.find(p=>p.codigo===v.codigo); if(prod) prod.stock-=v.cantidad; });
  guardarInventario();
  guardarVentas(ventaData);
  localStorage.setItem('folioCounter', folioCounter);

  // Ticket
  let ticket = "üíä FARMACIA ORTOPEDIA LILI üíä\n";
  ticket+="Calle Ejemplo #123, Ciudad, Estado | Tel: 55-1234-5678\n";
  ticket+=`Folio: ${ventaData.folio} | Cajero: ${usuarioActivo} | Fecha: ${fecha}\n`;
  ticket+="----------------------------------------\n";
  if(contieneAntibiotico){
    ticket+="üíâ Datos del Doctor üíâ\n";
    ticket+=`Nombre:${ventaData.doctor.nombre} C√©dula:${ventaData.doctor.cedula}\n`;
    ticket+=`Direcci√≥n:${ventaData.doctor.direccion} Folio:${ventaData.doctor.folioReceta}\n`;
    ticket+="----------------------------------------\n";
  }
  ticket+="Producto          C√≥digo  Cant Precio  Lote   Caducidad\n";
  ticket+="--------------------------------------------------------\n";
  venta.forEach(v=>{
    if(v.codigo.toUpperCase().startsWith("A")){
      ticket+=`${v.nombre.padEnd(16)} ${v.codigo.padEnd(7)} ${v.cantidad.toString().padEnd(5)} $${v.precio.toFixed(2).padEnd(6)} ${v.lote.padEnd(7)} ${v.caducidad}\n`;
    } else {
      ticket+=`${v.nombre.padEnd(16)} ${v.codigo.padEnd(7)} ${v.cantidad.toString().padEnd(5)} $${(v.precio*v.cantidad).toFixed(2)}\n`;
    }
  });
  ticket+="--------------------------------------------------------\n";
  ticket+=`TOTAL: $${total.toFixed(2)}\n`;
  ticket+=`M√©todo de Pago: ${metodoPago}\n\nGracias por su preferencia! üíä\n`;
  // Comando abrir caj√≥n: ESC p 0 25 250 (puede variar seg√∫n impresora)
  ticket+="\x1B\x70\x00\x19\xFA";

  // Imprimir inmediatamente
  const win = window.open('','Imprimir Ticket','width=100,height=600');
  win.document.write('<pre style="font-family:monospace;">'+ticket+'</pre>');
  win.print();
  win.close();

  // Limpiar venta
  venta=[];
  guardarVentaActiva();
  renderVenta();
  document.getElementById("clienteNombre").value="";
  document.getElementById("clienteCedula").value="";
  document.getElementById("clienteDireccion").value="";
  document.getElementById("folioReceta").value="";
  document.getElementById('pagoInput').value="";
  document.getElementById('cambioDisplay').value="";
};

// Nueva venta
document.getElementById("btnNuevaVenta").onclick = () => {
  if(confirm("¬øDesea iniciar una nueva venta?")){
    venta=[];
    guardarVentaActiva();
    renderVenta();
    document.getElementById("clienteNombre").value="";
    document.getElementById("clienteCedula").value="";
    document.getElementById("clienteDireccion").value="";
    document.getElementById("folioReceta").value="";
    document.getElementById('pagoInput').value="";
    document.getElementById('cambioDisplay').value="";
  }
};

renderVenta();
</script>
</body>
</html>
