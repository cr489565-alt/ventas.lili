<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>üìú Historial - Farmacia Ortopedia Lili</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<style>
body { font-family: system-ui, sans-serif; background:#1e2f52; color:#e5e7eb; margin:0; padding:0;}
header {
    background:#111827; 
    padding:16px; 
    font-size:30px; 
    font-weight:bold; 
    text-align:center; 
    position:relative;
}
header img {
    position:absolute;
    left:10px;
    top:50%;
    transform:translateY(-50%);
    height:40px;
      width: 150px;
    height: 100px;
    border-radius: 25px;
}
main { padding:16px; display:grid; gap:24px;}
section { background:linear-gradient(120deg,#111827 80%,#2563eb11 100%); padding:16px; border-radius:16px; box-shadow:0 0 22px rgba(0,0,0,.3);}
h2 { margin-top:0; color:#60a5fa; letter-spacing:1px;}
.table-container { width:100%; overflow-x:auto; margin-top:12px; }
table { width:100%; border-collapse: collapse; font-size:0.97em;}
th, td { border:1px solid #374151; padding:8px; text-align:left;}
th { background:#1f2937; }
tfoot td { font-weight:bold; background:#1f2937; }
button { padding:7px 13px; border:none; border-radius:7px; cursor:pointer; background:#2563eb; color:white; margin-top:8px; box-shadow:0 2px 4px #2563eb38;}
button.reimprimir { background:#f59e0b; }
button.realizar-corte { background:#16a34a; box-shadow:0 2px 6px #16a34a38;}
button.reembolso { background:#ef4444; box-shadow:0 2px 6px #ef4444a0; }
.main-menu { display:flex; gap:12px; background:#111827; padding:10px 16px; position:sticky; top:0; z-index:1000; border-bottom:1px solid #1f2937;}
.main-menu .menu-link {color:#e5e7eb; text-decoration:none; padding:8px 12px; border-radius:8px; font-weight:500; transition:0.2s;}
.main-menu .menu-link:hover {background:#1f2937;}
.main-menu .menu-link.active {background:#2563eb; color:white;}
#logout{background:#dc2626;margin-left:auto;padding:8px 12px;border-radius:8px;color:white;border:none;cursor:pointer;transition:0.2s;}
#logout:hover{background:#b91c1c;}
#cajero{font-size:14px;margin-left:16px;color:#facc15;}
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#00000088; justify-content:center; align-items:center; z-index:10000;}
.modal-content { background:#1e2f52; padding:20px; border-radius:12px; width:520px; color:#e5e7eb; max-height:90vh; overflow-y:auto;}
.modal-content input { width:90px; margin-left:10px; margin-bottom:6px; }
.modal-content label { display:flex; justify-content:space-between; margin-bottom:6px; align-items:center; }
#tablaCortes { width:100%; margin-top:12px; border-collapse:collapse; }
#tablaCortes th, #tablaCortes td { border:1px solid #374151; padding:6px; text-align:left;}
.total-row { font-weight:bold; margin-top:10px; }
.den-badge { display:inline-block; padding:6px 10px; border-radius:8px; color:#000; font-weight:600; margin-right:8px; min-width:72px; text-align:center; }
.red-row { background-color:#f87171 !important; }
.yellow-row { background-color:#fbbf24 !important; }

</style>
</head>
<body>
<header>  <img src="ventas.png" alt="Logo Ventas"> 
  üìú Historial - Farmacia Ortopedia Lili</header>
<nav class="main-menu">
  <a href="ven.html" class="menu-link">üí≥ Ventas</a>
  <a href="inven.html" class="menu-link">üì¶ Inventario</a>
  <a href="hitori.html" class="menu-link active">üìú Historial</a>
  <span id="cajero"></span>
  <button id="logout">Cerrar Sesi√≥n</button>
</nav>
<main>
  <section>
    <h2>üíµ Ventas Generales</h2>
    <div class="table-container">
      <table id="tabla-ventas-general">
        <thead>
          <tr>
            <th>Producto</th><th>C√≥digo</th><th>Cantidad</th><th>Folio</th><th>Fecha</th><th>Cajero</th><th>M√©todo</th><th>Subtotal</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr><td colspan="7">Total General</td><td id="total-general">$0.00</td></tr>
        </tfoot>
      </table>
      <button onclick="descargarPDF('tabla-ventas-general','Ventas_General')">üìÑ PDF Ventas</button>
      <button class="reembolso" onclick="abrirModalReembolso()">üí∏ Reembolso</button>
    </div>
  </section>

  <section>
    <h2>üíä Ventas Antibi√≥ticos</h2>
    <div class="table-container">
      <table id="tabla-antibioticos">
        <thead>
          <tr>
            <th>Producto</th><th>C√≥digo</th><th>Cantidad</th><th>Folio</th><th>Doctor</th><th>C√©dula</th><th>Direcci√≥n</th><th>Receta</th><th>Lote</th>
            <th>Fecha</th><th>Cajero</th><th>M√©todo</th><th>Subtotal</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td colspan="12">Total Antibi√≥ticos</td>
            <td id="total-antibioticos">$0.00</td>
          </tr>
        </tfoot>
      </table>
      <button onclick="descargarPDF('tabla-antibioticos','Antibioticos')">üìÑ PDF Antibi√≥ticos</button>
      <button class="realizar-corte" onclick="abrirModalCorte()">üíæ Realizar Corte</button>
    </div>
  </section>

  <section>
    <h2>üìä Historial de Cortes</h2>
    <table id="tablaCortes">
      <thead>
        <tr><th>Fecha</th><th>Cajero</th><th>Efectivo</th><th>Tarjeta</th><th>Transferencia</th><th>Proveedor</th><th>Total</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<!-- Modal Corte -->
<div class="modal" id="modalCorte">
  <div class="modal-content">
    <h3>üíµ Corte Diario - Efectivo</h3>
    <div id="billetesMonedas"></div>
    <hr>
    <label>Tarjeta: <input type="number" id="totalTarjeta" value="0" min="0"></label>
    <label>Transferencia: <input type="number" id="totalTransferencia" value="0" min="0"></label>
    <label>Proveedor: <input type="number" id="totalProveedor" value="0" min="0"></label>
    <div class="total-row">Total Efectivo: <span id="totalEfectivo">0</span></div>
    <div class="total-row">Total General: <span id="totalGeneralCorte">0</span></div>
    <div class="total-row" id="mensaje-error" style="color:#f87171; display:none;">El total de billetes no coincide con efectivo. Corrige los billetes.</div>
    <button onclick="validarCorte()">‚úÖ Continuar</button>
    <button onclick="cerrarModal()">‚ùå Cerrar</button>
  </div>
</div>

<!-- Modal Reembolso -->
<div class="modal" id="modalReembolso">
  <div class="modal-content">
    <h3>üí∏ Reembolso</h3>
    <label>Folio Venta: <input type="text" id="folioReembolso"></label>
    <label>Productos (c√≥digos separados por coma): <input type="text" id="productosReembolso"></label>
    <label>Contrase√±a Admin: <input type="password" id="passAdminReembolso"></label>
    <div class="total-row" id="mensaje-error-reembolso" style="color:#f87171; display:none;">Contrase√±a incorrecta o datos invalidos.</div>
    <button onclick="realizarReembolso()">üí∞ Realizar</button>
    <button onclick="cerrarModalReembolso()">‚ùå Cerrar</button>
  </div>
</div>

<script>
// Usuario activo
let usuarioActivo = localStorage.getItem("usuarioActivo");
const passAdmin = localStorage.getItem("passwordAdmin") || "admin123"; 
if(!usuarioActivo){ window.location.href="index.html"; }
else { document.getElementById("cajero").textContent = "üë§ Cajero: "+usuarioActivo; }

// Colores m√©todos pago
const metodoColor = { 'Efectivo':'#16a34a', 'Tarjeta':'#2563eb', 'Transferencia':'#7c3aed', 'Proveedor':'#f59e0b' };

// Formatear dinero
function formatDinero(num){ return "$"+(num||0).toFixed(2); }

// Cargar ventas
function cargarVentas(){ return JSON.parse(localStorage.getItem("ventas")||"[]"); }

// Renderizar ventas
function renderVentas(){
  const ventas = cargarVentas();
  const tbodyGeneral = document.querySelector('#tabla-ventas-general tbody');
  const tbodyAnt = document.querySelector('#tabla-antibioticos tbody');
  tbodyGeneral.innerHTML=''; tbodyAnt.innerHTML='';
  let totalG=0, totalA=0;

  ventas.forEach(v=>{
    (v.items||[]).forEach(item=>{
      const subtotal = item.precio*item.cantidad;
      const colorPagoG = metodoColor[v.metodo] || '#ffffff';
      const trG = document.createElement('tr');
      trG.innerHTML = `
        <td>${item.nombre}</td>
        <td>${item.codigo}</td>
        <td>${item.cantidad}</td>
        <td>${v.folio}</td>
        <td>${v.fecha}</td>
        <td>${v.cajero}</td>
        <td style="background:${colorPagoG};color:white;font-weight:bold;text-align:center;">${v.metodo}</td>
        <td>${formatDinero(subtotal)}</td>`;
      if(item.reembolsado) trG.classList.add('red-row');
      tbodyGeneral.appendChild(trG);
      totalG += subtotal;

      if(item.codigo.toString().toUpperCase().startsWith("A")){
        const colorPagoA = metodoColor[v.metodo] || '#ffffff';
        const trA=document.createElement('tr');
        trA.innerHTML=`<td>${item.nombre}</td>
          <td>${item.codigo}</td>
          <td>${item.cantidad}</td>
          <td>${v.folio}</td>
          <td>${v.doctor?.nombre||'-'}</td>
          <td>${v.doctor?.cedula||'-'}</td>
          <td>${v.doctor?.direccion||'-'}</td>
          <td>${v.doctor?.folioReceta||'-'}</td>
          <td>${item.lote||'-'}</td>
          <td>${v.fecha}</td>
          <td>${v.cajero}</td>
          <td style="background:${colorPagoA};color:white;font-weight:bold;text-align:center;">${v.metodo}</td>
          <td>${formatDinero(subtotal)}</td>`;
        if(item.reembolsado) trA.classList.add('red-row');
        tbodyAnt.appendChild(trA);
        totalA+=subtotal;
      }
    });
  });

  document.getElementById('total-general').textContent=formatDinero(totalG);
  document.getElementById('total-antibioticos').textContent=formatDinero(totalA);
}

// Descargar PDF
function descargarPDF(tablaId,nombre){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation:'landscape' });
  const tabla = document.getElementById(tablaId);
  doc.setFontSize(14);
  doc.text(`Farmacia Lily √ìptica - ${nombre}`,10,15);
  doc.setFontSize(10);
  doc.text(`Fecha: ${new Date().toLocaleString()}`,10,22);
  doc.autoTable({ html: tabla, startY:28, styles:{fontSize:8} });
  const fecha = new Date().toLocaleDateString().replace(/\//g,"-");
  doc.save(`${nombre}_${fecha}.pdf`);
}

// Logout
document.getElementById("logout").onclick=()=>{ localStorage.removeItem("usuarioActivo"); window.location.href="index.html"; };

// --- Modal Reembolso ---
const modalReembolso = document.getElementById('modalReembolso');
function abrirModalReembolso(){ modalReembolso.style.display='flex'; document.getElementById('mensaje-error-reembolso').style.display='none'; }
function cerrarModalReembolso(){ modalReembolso.style.display='none'; }

// Reembolso
function realizarReembolso(){
  const folio = document.getElementById('folioReembolso').value.trim();
  const codigos = document.getElementById('productosReembolso').value.trim().split(',').map(c=>c.trim());
  const pass = document.getElementById('passAdminReembolso').value.trim();

  if(pass !== passAdmin || !folio || codigos.length===0){
    document.getElementById('mensaje-error-reembolso').style.display='block';
    return;
  }

  let ventas = cargarVentas();
  const venta = ventas.find(v=>v.folio===folio);
  if(!venta){ alert("Folio no encontrado"); return; }

  const reembolsoItems = [];
  venta.items.forEach(item=>{
    if(codigos.includes(item.codigo) && !item.reembolsado){
      item.reembolsado = true;
      reembolsoItems.push(item);
      let inventario = JSON.parse(localStorage.getItem("inventario")||"[]");
      let prod = inventario.find(p=>p.codigo===item.codigo);
      if(prod) prod.stock += item.cantidad;
      localStorage.setItem("inventario", JSON.stringify(inventario));
    }
  });

  document.querySelectorAll('#tabla-ventas-general tbody tr').forEach(tr=>{
    if(tr.children[3].textContent===folio && codigos.includes(tr.children[1].textContent)){
      tr.classList.add('red-row');
    }
  });
  document.querySelectorAll('#tabla-antibioticos tbody tr').forEach(tr=>{
    if(tr.children[3].textContent===folio && codigos.includes(tr.children[1].textContent)){
      tr.classList.add('red-row');
    }
  });

  const fecha = new Date().toLocaleString();
  let ticket = `üíä FARMACIA ORTOPEDIA LILI - REEMBOLSO üíä\nFolio Venta: ${folio}\nFecha: ${fecha}\nCajero: ${usuarioActivo}\n-----------------------\n`;
  reembolsoItems.forEach(it=>{
    ticket += `Producto: ${it.nombre}\nCodigo: ${it.codigo}\nCantidad: ${it.cantidad}\nPrecio: ${formatDinero(it.precio)}\nSubtotal: ${formatDinero(it.precio*it.cantidad)}\n`;
    if(it.codigo.toUpperCase().startsWith("A")){
      ticket += `Doctor: ${venta.doctor?.nombre||'-'}\nC√©dula: ${venta.doctor?.cedula||'-'}\nReceta: ${venta.doctor?.folioReceta||'-'}\nDirecci√≥n: ${venta.doctor?.direccion||'-'}\n`;
    }
    ticket += `-----------------------\n`;
  });
  const totalReembolso = reembolsoItems.reduce((sum,it)=>sum+it.precio*it.cantidad,0);
  ticket += `Total Reembolsado: ${formatDinero(totalReembolso)}\n-----------------------\n`;

  const printWindow=window.open('','', 'height=400,width=300');
  printWindow.document.write('<pre>'+ticket+'</pre>');
  printWindow.document.close();
  printWindow.print();

  localStorage.setItem("ventas", JSON.stringify(ventas));
  renderVentas();
  cerrarModalReembolso();
}

// --- Modal Corte ---
const modal=document.getElementById('modalCorte');
function abrirModalCorte(){ modal.style.display='flex'; renderBilletesMonedas(); }
function cerrarModal(){ modal.style.display='none'; document.getElementById("mensaje-error").style.display='none'; }

const billetes = [1000,500,200,100,50,20]; 
const monedas = [10,5,2,1];
const denomInfo = { 1000:{emoji:'üíµ',color:'#8b5cf6',textColor:'#fff'},500:{emoji:'üíµ',color:'#f472b6',textColor:'#000'},200:{emoji:'üíµ',color:'#86efac',textColor:'#000'},100:{emoji:'üíµ',color:'#c7a97a',textColor:'#000'},50:{emoji:'üíµ',color:'#fbbf24',textColor:'#000'},20:{emoji:'üíµ',color:'#60a5fa',textColor:'#000'},10:{emoji:'ü™ô',color:'#facc15',textColor:'#000'},5:{emoji:'ü™ô',color:'#9ca3af',textColor:'#000'},2:{emoji:'ü™ô',color:'#b6865b',textColor:'#000'},1:{emoji:'ü™ô',color:'#6b7280',textColor:'#fff'} };

function renderBilletesMonedas(){ 
  const container=document.getElementById('billetesMonedas'); container.innerHTML=''; 
  const buildRow = (val)=>{
    const info = denomInfo[val] || {emoji:'',color:'#fff',textColor:'#000'};
    return `<label style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;"><div style="display:flex;align-items:center;"><span class="den-badge" style="background:${info.color};color:${info.textColor}">${info.emoji} ${val}</span><input type="number" min="0" value="0" data-valor="${val}" class="efectivoBillete" /></div><div>Total: <span class="totalBillete">0</span></div></label>`;
  };
  billetes.forEach(b=>container.innerHTML+=buildRow(b)); 
  monedas.forEach(m=>container.innerHTML+=buildRow(m)); 
  document.querySelectorAll('.efectivoBillete').forEach(inp=>{ inp.addEventListener('input', calcularTotales); }); 
  ['totalTarjeta','totalTransferencia','totalProveedor'].forEach(id=>{ const el=document.getElementById(id); if(el) el.addEventListener('input',calcularTotales); }); 
  calcularTotales(); 
}

function calcularTotales(){ 
  let totalEfectivo=0; 
  document.querySelectorAll('.efectivoBillete').forEach(inp=>{ 
    const cant=parseInt(inp.value)||0; 
    const val=parseInt(inp.dataset.valor)||0; 
    const subtotal=cant*val; 
    const label=inp.closest('label'); 
    const span=label?label.querySelector('.totalBillete'):null; 
    if(span) span.textContent=subtotal; 
    totalEfectivo+=subtotal; 
  }); 
  const tarjeta=parseFloat(document.getElementById('totalTarjeta').value)||0; 
  const transferencia=parseFloat(document.getElementById('totalTransferencia').value)||0; 
  const proveedor=parseFloat(document.getElementById('totalProveedor').value)||0; 
  document.getElementById('totalEfectivo').textContent=totalEfectivo; 
  document.getElementById('totalGeneralCorte').textContent=(totalEfectivo+tarjeta+transferencia+proveedor).toFixed(2); 
}

function validarCorte(){ 
  const totalEfectivo=parseFloat(document.getElementById('totalEfectivo').textContent)||0; 
  let totalBilletes=0; 
  document.querySelectorAll('.efectivoBillete').forEach(inp=>{ totalBilletes += (parseInt(inp.value)||0) * (parseInt(inp.dataset.valor)||0); }); 
  if(totalEfectivo !== totalBilletes){ 
    document.getElementById("mensaje-error").style.display='block'; 
    return; 
  } 
  document.getElementById("mensaje-error").style.display='none'; 
  finalizarCorte(); 
}

function finalizarCorte(){ 
  const totalEfectivo=parseFloat(document.getElementById('totalEfectivo').textContent)||0; 
  const tarjeta=parseFloat(document.getElementById('totalTarjeta').value)||0; 
  const transferencia=parseFloat(document.getElementById('totalTransferencia').value)||0; 
  const proveedor=parseFloat(document.getElementById('totalProveedor').value)||0; 
  const fecha=new Date().toLocaleString(); 
  const total=totalEfectivo+tarjeta+transferencia+proveedor; 

  // Guardar corte
  let cortes=localStorage.getItem("cortes"); 
  cortes = cortes ? JSON.parse(cortes) : []; 
  cortes.push({fecha,cajero:usuarioActivo,efectivo:totalEfectivo,tarjeta,transferencia,proveedor,total}); 
  localStorage.setItem("cortes",JSON.stringify(cortes)); 

  // Limpiar ventas (incluyendo reembolsos)
  localStorage.setItem("ventas","[]"); 
  document.querySelector('#tabla-ventas-general tbody').innerHTML=''; 
  document.querySelector('#tabla-antibioticos tbody').innerHTML=''; 
  document.getElementById('total-general').textContent="$0.00";
  document.getElementById('total-antibioticos').textContent="$0.00";
  document.getElementById('totalEfectivo').textContent="0";
  document.getElementById('totalTarjeta').value="0";
  document.getElementById('totalTransferencia').value="0";
  document.getElementById('totalProveedor').value="0";
  document.getElementById('totalGeneralCorte').textContent="0";

  const ticket=` \nCORTE DIARIO\n-------------------------------\nCajero: ${usuarioActivo}\nFecha: ${fecha}\n\nEfectivo: $${totalEfectivo}\nTarjeta: $${tarjeta}\nTransferencia: $${transferencia}\nProveedor: $${proveedor}\n\n-------------------------------\nTotal: $${total.toFixed(2)}\n-------------------------------\nFirma: _______________________\n`; 
  const printWindow=window.open('','', 'height=400,width=300'); 
  printWindow.document.write('<pre>'+ticket+'</pre>'); 
  printWindow.document.close(); 
  printWindow.print(); 

  cerrarModal(); 
  cargarCortes(); 
}

function cargarCortes(){ 
  let cortes=localStorage.getItem("cortes"); 
  cortes = cortes ? JSON.parse(cortes) : []; 
  const tbody=document.querySelector('#tablaCortes tbody'); 
  tbody.innerHTML=''; 
  cortes.forEach(c=>{ 
    const tr=document.createElement('tr'); 
    tr.innerHTML=`<td>${c.fecha}</td><td>${c.cajero}</td><td style="background:${metodoColor['Efectivo']};color:white;">${c.efectivo||0}</td><td style="background:${metodoColor['Tarjeta']};color:white;">${c.tarjeta||0}</td><td style="background:${metodoColor['Transferencia']};color:white;">${c.transferencia||0}</td><td style="background:${metodoColor['Proveedor']};color:white;">${c.proveedor||0}</td><td>${c.total||0}</td>`; 
    tbody.appendChild(tr); 
  }); 
}

// Inicializar
(function(){ renderVentas(); cargarCortes(); })();
</script>
</body>
</html>
