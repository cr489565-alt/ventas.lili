<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>üì¶ Inventario - FarmaciaLili 2.0 üì¶ </title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<style>
/* --- estilos --- */
* {box-sizing:border-box;}
body { font-family: system-ui, sans-serif; background:#f9fafb; color:#1f2937; margin:0; padding:0;}
header { background:#2563eb; color: white; padding: 30px; font-size: 26px; font-weight: bold; text-align: center; position: relative; box-shadow: 0 2px 10px rgba(0,0,0,0.2);}
header img { position:absolute; left:10px; top:50%; transform:translateY(-50%); width:150px; height:100px; border-radius:25px; border: 2px solid #e5e7eb;}
main {padding:16px; display:flex; flex-direction:column; gap:16px;}
.main-menu { display:flex; gap:12px; background:#ffffff; padding:10px 16px; position:sticky; top:0; z-index:1000; border-bottom:1px solid #e5e7eb; box-shadow: 0 2px 4px rgba(0,0,0,0.05);}
.main-menu .menu-link {color:#1f2937; text-decoration:none; padding:8px 12px; border-radius:8px; font-weight:500; transition:0.2s; border: 1px solid #e5e7eb;}
.main-menu .menu-link:hover {background:#e5e7eb; color:#111827;}
.main-menu .menu-link.active {background:#2563eb; color:white; border-color: #2563eb;}
#logout {background:#dc2626; margin-left:auto; padding:8px 12px; border-radius:8px; color:white; border:none; cursor:pointer; transition:0.2s; font-weight: 500;}
#logout:hover {background:#b91c1c;}
#admin {background:#26a9dc; padding:8px 12px; border-radius:8px; color:white; border:none; cursor:pointer; transition:0.2s; font-weight: 500;}
#admin:hover {background:#2563eb;}
#searchBar {margin-left:10px; padding:8px; border-radius:6px; border:1px solid #d1d5db; width:200px; background: #f9fafb;}
#cajero {font-size:14px; margin-left:16px; color:#2563eb; font-weight: 500;}
input, button, select {padding:9px; border-radius:6px; border:1px solid #d1d5db; margin:4px 0; background: #f9fafb; color: #1f2937;}
input, select {width:200px; background: #ffffff;}
button {background:#2563eb; color:white; cursor:pointer; font-weight:bold; border: none;}
button:hover {background:#1d4ed8;}
.btn{padding:0.4rem 1rem; border:none; border-radius:8px; cursor:pointer; font-weight:500; transition:0.2s; border: 1px solid transparent;}
.btn-edit{background:#2563eb; color:#fff;} .btn-edit:hover{background:#1e40af; border-color: #1e40af;}
.btn-del{background:#dc2626; color:#fff;} .btn-del:hover{background:#991b1b; border-color: #991b1b;}
.btn-pdf{background:#facc15; color:#000; margin-left:5px;} .btn-pdf:hover{background:#eab308; border-color: #eab308;}
.oculto{display:none;}
.panel-admin{background:#ffffff; border:2px solid #2563eb; padding:1rem; border-radius:12px; margin-bottom:1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.05);}
/* Colores din√°micos */
.stock-verde{background:#16a34a; color:#fff;}
.stock-amarillo{background:#eab308; color:#000;}
.stock-rojo{background:#b91c1c; color:#fff;}
.stockmin-rojo{background:#f6ff00; color:#000;}
.cad-verde{background:#16a34a; color:#fff;}
.cad-amarillo{background:#eab308; color:#000;}
.cad-rojo{background:#b91c1b; color:#fff;}
.entradas-azul{background:#2563eb; color:#fff;}
.categoria-farmacia{background:#9d4edd; color:#fff;}
.categoria-tienda{background:#7c3e12; color:#fff;}
.categoria-antibiotico{background:#f97316; color:#fff;}
.categoria-papeleria{background:#ec4899; color:#fff;}
.categoria-proveedores{background:#f59e0b; color:#fff;}
.categoria-bebes{background:#22d3ee; color:#000;}
.categoria-tecnologia{background:#6366f1; color:#fff;}
.categoria-accesorios{background:#f43f5e; color:#fff;}
section { text-align: center; width: 95%; background: linear-gradient(120deg,#ffffff 80%,#dbeafe 100%); padding: 24px; border-radius: 15px; box-shadow: 0 8px 28px rgba(0,0,0,.1); margin: 12px auto; border: 1px solid #000000; }
h2.seccion { display:flex; justify-content:space-between; align-items:center; margin-top:0; color:#000000; background: #067be8; padding: 10px; border-radius: 8px; }
table {width:100%; border-collapse:collapse; margin-top:12px; background: #ffffff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05);}
th, td {padding:12px; border:1px solid #e5e7eb; text-align:left; font-size: 14px;}
th {background:#f3f4f6; color: #111827; font-weight: 600;}
tr:nth-child(even) { background-color: #f9fafb; }
tr:hover { background-color: #f3f4f6; }
/* Ajustes para el formulario de login */
#loginSection input { background: #ffffff; border: 1px solid #d1d5db; }
#loginSection button { background: #2563eb; color: white; border: none; }
/* Ajustes para el panel admin */
#adminSection input, #adminSection select { background: #ffffff; border: 1px solid #d1d5db; }
#adminSection button { background: #2563eb; color: white; border: none; }
</style>
</head>
<body>
<header>
    <img src="ventas.png" alt="Logo Ventas">
    üì¶ Inventario - FarmaciaLili 3.0 üì¶ 
</header>
<nav class="main-menu">
  <a href="farma3.html" class="menu-link">üí≥ Ventas</a>
  <a href="inve3.html" class="menu-link active">üì¶ Inventario</a>
  <a href="histori3.html" class="menu-link ">üìú Historial</a>
  <span id="cajero"></span>
  <button id="admin">üîë Admin</button>
  <input type="text" id="searchBar" placeholder="üîé Buscar...">
  <button id="btnSubirInventario" class="btn btn-pdf">üìä Subir Inventario</button>
  <input type="file" id="fileInput" accept=".csv" class="oculto">
  <button id="logout">Cerrar Sesi√≥n</button>
</nav>

<section id="loginSection" class="oculto">
  <h2>üëë PANEL ADMINISTRACI√ìN üëë</h2>
  üîê Ingresa Contrase√±a
  <form id="loginForm">
    <input type="password" id="adminPass" placeholder="Contrase√±a" required>
    <button type="submit" class="btn btn-edit">Ingresar</button>
  </form>
</section>

<section id="adminSection" class="oculto panel-admin">
  <h2>‚öôÔ∏è Panel Administrador</h2>
  <form id="addForm" style="margin-top:1rem;">
    <h3>‚ûï Agregar Producto</h3>
    <input type="text" id="nombre" placeholder="Nombre" required>
    <input type="text" id="codigo" placeholder="C√≥digo" required>
    <input type="number" id="precio" placeholder="Precio">
    <div id="loteCadFields" class="oculto">
      <input type="text" id="lote" placeholder="Lote (solo antibi√≥ticos)">
      <input type="date" id="caducidad" placeholder="Caducidad (solo antibi√≥ticos)">
    </div>
    <input type="number" id="stock" placeholder="Stock">
    <input type="number" id="stockMin" placeholder="Stock M√≠nimo">
    <input type="number" id="entradas" placeholder="Entradas">
    <select id="categoria" required>
      <option value="Antibi√≥tico">Antibi√≥tico</option>
      <option value="Papeler√≠a">Papeler√≠a</option>
      <option value="Tienda">Tienda</option>
      <option value="Farmacia">Farmacia</option>
      <option value="Proveedores">Proveedores</option>
      <option value="Beb√©s">Beb√©s</option>
      <option value="Tecnolog√≠a">Tecnolog√≠a</option>
      <option value="Accesorios">Accesorios</option>
    </select>
    <div style="margin-top:10px;">
      <button type="submit" class="btn btn-edit">Guardar</button>
      <button type="button" id="salirAdmin" class="btn btn-del">Salir</button>
    </div>
  </form>
</section>

<section id="generalSection">
  <h2 class="seccion">üì¶ Inventario - General
    <button class="btn btn-pdf" onclick="imprimirPDF('tablaGeneralCompleta','Inventario General')">üìÑ General</button>
    <button class="btn btn-pdf" onclick="imprimirPDF('tablaAntibioticos','Inventario Antibi√≥ticos')">üíä Antibi√≥ticos</button>
  </h2>
  <table id="tablaGeneralCompleta">
    <thead>
      <tr>
        <th>Nombre</th><th>C√≥digo</th><th>Precio</th><th>Lote</th>
        <th>Stock</th><th>Stock M√≠nimo</th><th>Entradas</th>
        <th>Categor√≠a</th><th>Caducidad</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<section id="AntibioticosSection">
  <h2 class="seccion">üíä Antibi√≥ticos</h2>
  <table id="tablaAntibioticos">
    <thead>
      <tr>
        <th>Nombre</th><th>C√≥digo</th><th>Precio</th><th>Lote</th>
        <th>Stock</th><th>Stock M√≠nimo</th><th>Entradas</th>
        <th>Categor√≠a</th><th>Caducidad</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<section id="ProveedoresSection">
  <h2 class="seccion">üì¶ Proveedores</h2>
  <table id="tablaProveedores">
    <thead>
      <tr>
        <th>Nombre</th><th>C√≥digo</th><th>Categor√≠a</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<script>
let usuarioActivo = localStorage.getItem("usuarioActivo") || "Cajero";
document.getElementById("cajero").textContent = "üë§ Cajero: " + usuarioActivo;
let userType='cajero';

const adminBtn=document.getElementById('admin');
const loginSection=document.getElementById('loginSection');
const adminSection=document.getElementById('adminSection');
const loginForm=document.getElementById('loginForm');
const addForm=document.getElementById('addForm');
const categoriaSelect=document.getElementById('categoria');
const salirAdmin=document.getElementById('salirAdmin');
const loteCadFields=document.getElementById('loteCadFields');
const tablaGeneral=document.getElementById('tablaGeneralCompleta').querySelector('tbody');
const tablaAntibioticos=document.getElementById('tablaAntibioticos').querySelector('tbody');
const tablaProveedores=document.getElementById('tablaProveedores').querySelector('tbody');

let productosInventario = JSON.parse(localStorage.getItem('inventario')) || [];
let productoEnEdicion = null;

// Guardar producto
function guardarProductoLocal(producto){
  if(productoEnEdicion){
    const index = productosInventario.findIndex(p=>p.codigo===productoEnEdicion.codigo);
    productosInventario[index] = producto;
    productoEnEdicion = null;
  }else{
    productosInventario.push(producto);
  }
  localStorage.setItem('inventario', JSON.stringify(productosInventario));
  renderTablasInventario();
}

// Eliminar producto
function eliminarProductoLocal(codigo){
  productosInventario = productosInventario.filter(p=>p.codigo!==codigo);
  localStorage.setItem('inventario', JSON.stringify(productosInventario));
  renderTablasInventario();
}

// Renderizado
function renderTablasInventario(){
  tablaGeneral.innerHTML = '';
  tablaAntibioticos.innerHTML = '';
  tablaProveedores.innerHTML = '';

  productosInventario.forEach(p=>{
    if(p.categoria!=='Proveedores'){
      const row = document.createElement('tr');
      row.innerHTML=`
        <td>${p.nombre||"ND"}</td>
        <td>${p.codigo||"ND"}</td>
        <td>${p.precio?`$${p.precio}`:"ND"}</td>
        <td>${p.categoria==='Antibi√≥tico' ? (p.lote||"ND") : "ND"}</td>
        <td class="${getStockClass(p.stock,p.stockMin)}">${p.stock||"ND"}</td>
        <td class="stockmin-rojo">${p.stockMin||"ND"}</td>
        <td class="entradas-azul">${p.entradas||"ND"}</td>
        <td class="${getCategoriaClass(p.categoria)}">${p.categoria||"ND"}</td>
        <td class="${p.categoria==='Antibi√≥tico' ? getCaducidadClass(p.caducidad) : ''}">${p.categoria==='Antibi√≥tico' ? (p.caducidad||"ND") : "ND"}</td>
        <td>${userType==='admin'
            ?`<button class="btn btn-edit" onclick='editarProducto(${JSON.stringify(p)})'>‚úèÔ∏è</button>
               <button class="btn btn-del" onclick='eliminarProductoLocal("${p.codigo}")'>üóëÔ∏è</button>` 
            :''}</td>
      `;
      tablaGeneral.appendChild(row);
      if(p.categoria==='Antibi√≥tico') tablaAntibioticos.appendChild(row.cloneNode(true));
    } else {
      const row = document.createElement('tr');
      row.innerHTML=`
        <td>${p.nombre||"ND"}</td>
        <td>${p.codigo||"ND"}</td>
        <td class="${getCategoriaClass(p.categoria)}">${p.categoria||"ND"}</td>
        <td>${userType==='admin'
            ?`<button class="btn btn-edit" onclick='editarProducto(${JSON.stringify(p)})'>‚úèÔ∏è</button>
               <button class="btn btn-del" onclick='eliminarProductoLocal("${p.codigo}")'>üóëÔ∏è</button>` 
            :''}</td>
      `;
      tablaProveedores.appendChild(row);
    }
  });
}

// --- Clases ---
function getStockClass(stock, min){if(stock<=min+10) return 'stock-rojo'; if(stock>min+10 && stock<=min+20) return 'stock-amarillo'; return 'stock-verde';}
function getCaducidadClass(fechaCad){if(!fechaCad) return ''; const hoy=new Date(); const cad=new Date(fechaCad); const diff=(cad-hoy)/(1000*60*60*24); if(diff<=20) return 'cad-rojo'; if(diff>20 && diff<=50) return 'cad-amarillo'; return 'cad-verde';}
function getCategoriaClass(cat){
  switch(cat){
    case 'Farmacia':return 'categoria-farmacia';
    case 'Tienda':return 'categoria-tienda';
    case 'Antibi√≥tico':return 'categoria-antibiotico';
    case 'Papeler√≠a':return 'categoria-papeleria';
    case 'Proveedores':return 'categoria-proveedores';
    case 'Beb√©s':return 'categoria-bebes';
    case 'Tecnolog√≠a':return 'categoria-tecnologia';
    case 'Accesorios':return 'categoria-accesorios';
    default:return '';
  }
}

// Agregar producto
addForm.addEventListener('submit', e=>{
    e.preventDefault(); 
    const p = {
        nombre: document.getElementById('nombre').value,
        codigo: document.getElementById('codigo').value,
        precio: parseFloat(document.getElementById('precio').value)||0,
        lote: document.getElementById('lote').value,
        stock: parseInt(document.getElementById('stock').value)||0,
        stockMin: parseInt(document.getElementById('stockMin').value)||0,
        entradas: parseInt(document.getElementById('entradas').value)||0,
        categoria: document.getElementById('categoria').value,
        caducidad: document.getElementById('caducidad').value
    };
    guardarProductoLocal(p);
    addForm.reset();
});

// Editar producto
function editarProducto(p){
    productoEnEdicion = p;
    document.getElementById('nombre').value = p.nombre;
    document.getElementById('codigo').value = p.codigo;
    document.getElementById('precio').value = p.precio;
    document.getElementById('lote').value = p.lote;
    document.getElementById('stock').value = p.stock;
    document.getElementById('stockMin').value = p.stockMin;
    document.getElementById('entradas').value = p.entradas;
    document.getElementById('categoria').value = p.categoria;
    document.getElementById('caducidad').value = p.caducidad;
    adminSection.classList.remove('oculto');
    loginSection.classList.add('oculto');
    userType='admin';
}

// Login admin
adminBtn.addEventListener('click', ()=>{
    loginSection.classList.remove('oculto');
});
loginForm.addEventListener('submit', e=>{
    e.preventDefault();
    const pass = document.getElementById('adminPass').value;
    if(pass==='12345'){ // contrase√±a fija
        loginSection.classList.add('oculto');
        adminSection.classList.remove('oculto');
        userType='admin';
        renderTablasInventario();
    } else alert('‚ùå Contrase√±a incorrecta');
});
salirAdmin.addEventListener('click', ()=>{
    adminSection.classList.add('oculto');
    loginSection.classList.add('oculto');
    userType='cajero';
    renderTablasInventario();
});

// Buscar productos
document.getElementById('searchBar').addEventListener('input', e=>{
    const term=e.target.value.toLowerCase();
    productosInventario.forEach(p=>{
        p.visible = p.nombre.toLowerCase().includes(term) || p.codigo.toLowerCase().includes(term);
    });
    renderTablasInventario();
});

// Subir CSV
const btnSubirInventario = document.getElementById('btnSubirInventario');
const fileInput = document.getElementById('fileInput');

btnSubirInventario.addEventListener('click', ()=> fileInput.click());

fileInput.addEventListener('change', e=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = evt=>{
        procesarCSV(evt.target.result);
        fileInput.value="";
    };
    reader.readAsText(file);
});

function procesarCSV(csvText){
    const lines = csvText.split(/\r?\n/).filter(l=>l.trim()!=="");
    lines.forEach((line,index)=>{
        if(index===0) return; // encabezado
        const [nombre, codigo, precio, lote, stock, stockMin, entradas, categoria, caducidad] = line.split(",");
        const p = {
            nombre: nombre||"ND",
            codigo: codigo||"ND",
            precio: parseFloat(precio)||0,
            lote: lote||"",
            stock: parseInt(stock)||0,
            stockMin: parseInt(stockMin)||0,
            entradas: parseInt(entradas)||0,
            categoria: categoria||"ND",
            caducidad: caducidad||""
        };
        guardarProductoLocal(p);
    });
    alert("‚úÖ Inventario cargado correctamente");
}

// PDF
function imprimirPDF(tablaId, titulo){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text(titulo, 14, 15);
    doc.autoTable({ html: '#'+tablaId, startY: 20 });
    doc.save(`${titulo}.pdf`);
}

// Inicial render
renderTablasInventario();
</script>
</body>
</html>
